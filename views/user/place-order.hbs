<link rel="stylesheet" href="/stylesheets/place-order.css">
<link rel="stylesheet" href="/stylesheets/popup.css">


<section class="" style="padding-top: 30px;">
    <div class="container">
        <div class="title">
            <h2>Confirm Your Order</h2>
        </div>
        <div class="d-flex">
            <form id="checkout-form">
                <div class="main" style="display: flex;">
                    <div class="formSection">
                        <label>
                            <span class="fname">First Name <span class="required">*</span></span>
                            <input id="fname" value="" type="text" name="fname">
                        </label>
                        <label>
                            <span class="lname">Last Name <span class="required">*</span></span>
                            <input id="lname" value="" type="text" name="lname">
                        </label>
                        <label>
                            <span>Street Address <span class="required">*</span></span>
                            <input id="address" value="" type="text" name="address" placeholder="street name" required>
                        </label>
                        <label>
                            <span>Phone <span class="required">*</span></span>
                            <input id="mobile" value="" type="tel" name="mobile">
                        </label>
                        <label>
                            <span>Email Address <span class="required">*</span></span>
                            <input id="email" value="" type="email" name="email">
                            <input type="text" name="userId" value="{{user._id}}" hidden>
                        </label>
                        <div class="checkBtn">
                            <form class="checkBox" action="#">
                                <input type="checkbox" id="test1" />
                                <label class="checkBoxLab" for="test1">Save Your address</label>
                            </form>
                        </div>


                        <div>

                            <div class="contact-container">
                                <h2>Use old address</h2>
                                <ul class="actions" style="list-style-type:none;">
                                    <li><a href="#" id="contact" class="button big btn btn-success">Click</a></li>
                                </ul>
                            </div>

                            {{!-- <div class="oldAdress">
                                <h4 class="lastAddress">Last few Addresses</h4>
                                {{#each address}}
                                <div style="display: list-item;">
                                    <div class="old">
                                        <h4>{{this.deliveryDetails.firstName}}</h4>
                                        <h4>{{this.deliveryDetails.lastName}}</h4>
                                        <h4>{{this.deliveryDetails.address}}</h4>
                                        <h4>{{this.deliveryDetails.mobile}}</h4>
                                        <h4>{{this.deliveryDetails.email}}</h4>
                                    </div>
                                    <div>
                                        <a href="/place-order" style="float: right;" class="btn btn-success">Use</a>
                                        <butto id="ids" style="float: right;" class="btn btn-success" onclick="addresss('{{this.deliveryDetails.name}}', '{{this.deliveryDetails.address}}', 
                                    '{{this.deliveryDetails.mobile}}', '{{this.deliveryDetails.email}}')">Use
                                        </butto>
                                    </div>
                                </div>
                                {{/each}}
                            </div> --}}

                            <div id="popups" class="cd-popup contact" role="alert">
                                <div name="contactform" id="contactform" class="contact-form">
                                    <div class="cd-popup-container" style="">

                                        <div class="row">
                                            <div class="column">
                                                {{#each address}}
                                                <div class="card">
                                                    <h4>{{this.deliveryDetails.firstName}}</h4>
                                                    <h4>{{this.deliveryDetails.lastName}}</h4>
                                                    <h4>{{this.deliveryDetails.address}}</h4>
                                                    <h4>{{this.deliveryDetails.mobile}}</h4>
                                                    <h4>{{this.deliveryDetails.email}}</h4>
                                                </div>
                                                <butto id="ids" style="float: right;" class="btn btn-success" onclick="addresss('{{this.deliveryDetails.firstName}}', '{{this.deliveryDetails.lastName}}', '{{this.deliveryDetails.address}}', 
                                    '{{this.deliveryDetails.mobile}}', '{{this.deliveryDetails.email}}')">Use
                                                </butto>
                                                {{/each}}

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="cd-popup notification" role="alert">
                                <div class="cd-popup-container">
                                    <a href="" class="cd-popup-close cd-close-button"><i class="fa fa-times"
                                            style="pointer-events:none;"></i></a>
                                    <p>
                                    <h3 id="notification-text">Thanks for getting in touch!</h3>
                                    </p>
                                </div>
                            </div>
                        </div>


                    </div>
                    <div class="Yorder">
                        <table>
                            <tr>
                                <th colspan="2">Your order</th>
                            </tr>
                            <tr>
                                <td>Product Name x 2(Qty)</td>
                                <td>₹{{total}}</td>
                            </tr>
                            <tr>
                                <td>Subtotal</td>
                                <td>₹{{total}}</td>
                            </tr>
                            <tr>
                                <td>Shipping</td>
                                <td>Free shipping</td>
                            </tr>
                        </table><br>
                        <div>
                            <input type="radio" name="paymentMethod" value="COD"> COD
                        </div>
                        <div>
                            <input type="radio" name="paymentMethod" value="RazorPay"> RazorPay <span>
                                <img src="https://www.logolynx.com/images/logolynx/c3/c36093ca9fb6c250f74d319550acac4d.jpeg"
                                    alt="" width="50">
                            </span>
                        </div>
                        <div>
                            <input type="radio" name="paymentMethod" value="PayPal"> PayPal <span>
                                <img src="https://www.logolynx.com/images/logolynx/c3/c36093ca9fb6c250f74d319550acac4d.jpeg"
                                    alt="" width="50">
                            </span>
                        </div>

                        <div id="paypal-button-container" class="" style="display: flex; width: 100%;"></div>

                        <div id="orderBtn" style="width: 100%;">
                            <button id="place-order" type="submit" style="font-family: sans-serif;"
                                onclick="myFunction()">place
                                order</button>
                        </div>
                        {{!-- <div>
                            <button id="cards-button-container" type="submit"
                                style="display: none; font-family: sans-serif;">Cash on Delivery</button>
                        </div> --}}

                    </div><!-- Yorder -->
                </div>
            </form>
        </div>
    </div>

</section>

<script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script src="/javascripts/popup.js"></script>
<script src="js/index.js"></script>

<script>
    function addresss(firstName, lastName, address, mobile, email) {
        document.getElementById("fname").value = firstName
        document.getElementById("lname").value = lastName
        document.getElementById("address").value = address
        document.getElementById("mobile").value = mobile
        document.getElementById("email").value = email
        document.getElementById("popups").style.display = "none";
    }
</script>

{{!-- /*******Check Button --}}
<script>
    function myFunction() {
        var checkBox = document.getElementById("test1");
        var text = document.getElementById("text");
        if (checkBox.checked == true) {

            $.ajax({
                url: '/saveAddress',
                method: 'post',
                data: $('#checkout-form').serialize(), // SERIALIZE Geting all data from a form
            })
            document.getElementById("checkout-form").submit();

        } else {

            document.getElementById("checkout-form").submit();
        }
    }
</script>

{{!-- //*********Paypal integration************\\ --}}

<script>

    $('#checkout-form').submit((e) => {
        e.preventDefault()
        $.ajax({
            url: '/place-order',
            method: 'post',
            data: $('#checkout-form').serialize(), // SERIALIZE Geting all data from a form
            success: (response) => {

                if (response.success) {
                    let id = response.success
                    location.href = `/order-success/${id}`
                }

                else if (response.Razorpay) {
                    let orderId = response.Razorpay
                    console.log("idddddddddddd", orderId)
                    razorpayPayment(orderId)
                }

                else if (response.Paypal) {
                    //worked()
                    document.querySelector('#orderBtn').style.display = "none";
                    let id = response.Paypal.id;
                    let amount = response.Paypal.amount;
                    paypalPayment(id, amount);

                }
            }
        })
    })


    function paypalPayment(id, amount) {

        // Render the PayPal button into #paypal-button-container
        paypal.Buttons({

            // Set up the transaction
            createOrder: function (data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            currency_cod: 'USD',
                            value: amount
                        }
                    }]
                });
            },

            // Finalize the transaction
            onApprove: function (data, actions) {
                return actions.order.capture().then(function (details) {
                    alert('Transaction completed by ' + details.payer.name.given_name + '!')
                    verifyPaypal(id)
                });
            }
        }).render('#paypal-button-container');
    }

    function verifyPaypal(id) {
        $.ajax({
            url: '/verify-paypal',
            data: {
                orderId: id,
            },
            method: 'post',
            success: (response) => {
                if (response) {
                    location.href = `/order-success/${id}`
                } else {
                    alert("payment failed")
                }
            }
        })
    }


    //RazorPay integration

    function razorpayPayment(order) {

        var options = {
            "key": "rzp_test_CyyEWbJn9u0YOv", // Enter the Key ID generated from the Dashboard
            "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            "currency": "INR",
            "name": "clouD techI onE",
            "description": "Test Transaction",
            "image": "https://example.com/your_logo",
            "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
            "handler": function (response) {
                verifyPayment(response, order)
            },
            "prefill": {
                "name": "Gaurav Kumar",
                "email": "gaurav.kumar@example.com",
                "contact": "9999999999"
            },
            "notes": {
                "address": "Razorpay Corporate Office"
            },
            "theme": {
                "color": "#3399cc"
            }
        };
        var rzp1 = new Razorpay(options);
        rzp1.open();
    }

    function verifyPayment(payment, order) {
        $.ajax({
            url: '/verify-payment',
            data: {
                payment,
                order,
            },
            method: 'post',
            success: (response) => {
                if (response) {
                    let id = response.success
                    location.href = `/order-success/${id}`
                } else {
                    alert("payment failed")
                }
            }
        })
    }

</script>